name: Download fonts
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - main
    paths-ignore:
      - "**/README.md"

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Clone Repository
      uses: actions/checkout@main

    - name: Install p7zip
      run: sudo apt-get update && sudo apt-get install -y p7zip

    - name: Set variables
      run: |
        echo "misans_download_url=https://hyperos.mi.com/font-download/MiSans.zip" >> ${GITHUB_ENV}
        echo "resource_download_url=https://github.com/CyanoHao/Resource-Han-Rounded/releases/download" >> ${GITHUB_ENV}
        echo "maple_download_url=https://github.com/subframe7536/maple-font/releases/download" >> ${GITHUB_ENV}
        echo "lxgw_download_url=https://github.com/lxgw/LxgwWenKai/releases/download" >> ${GITHUB_ENV}
        echo "source_download_url=https://github.com/adobe-fonts/source-han-serif/releases/download" >> ${GITHUB_ENV}
        echo "noto_download_url=https://raw.githubusercontent.com/googlefonts/noto-emoji/main/fonts/NotoColorEmoji_WindowsCompatible.ttf" >> ${GITHUB_ENV}
      shell: bash

    - name: Download `MiSans`
      run: |
        mkdir -p ./tmp/ ./MiSans/ ./fonts/
        wget -P ./tmp/ "${misans_download_url}"
        unzip -o ./tmp/MiSans.zip -d ./tmp/
        misans_time=$(date -d "$(stat -c %y "./tmp/MiSans/otf/MiSans-Regular.otf")" +"%Y-%m-%d")
        echo "misans_time=$misans_time" >> ${GITHUB_ENV}
        cp -f ./tmp/MiSans/otf/MiSans-* ./MiSans/
        rm -rf ./tmp*

    - name: Download `Resource Han Rounded CN`
      run: |
        mkdir -p ./tmp/Resource-Han-Rounded-CN/ ./Resource-Han-Rounded-CN/
        resource_version=$(curl -sSL https://api.github.com/repos/CyanoHao/Resource-Han-Rounded/releases/latest | jq -r '.tag_name' | sed 's/^v//')
        echo "resource_version=$resource_version" >> ${GITHUB_ENV}
        resource_time=$(curl -sSL https://api.github.com/repos/CyanoHao/Resource-Han-Rounded/releases/latest | jq -r '.created_at' | xargs -I {} date -d '{} +8 hours' '+%Y-%m-%d')
        echo "resource_time=$resource_time" >> ${GITHUB_ENV}
        wget -P ./tmp/ "${resource_download_url}/v${resource_version}/RHR-CN-${resource_version}.7z"
        7z x ./tmp/RHR-CN-${resource_version}.7z -o./tmp/Resource-Han-Rounded-CN/
        cp -f ./tmp/Resource-Han-Rounded-CN/ResourceHanRoundedCN-* ./Resource-Han-Rounded-CN/
        rm -rf ./tmp*

    - name: Download `Maple Mono NF CN`
      run: |
        mkdir -p ./tmp/Maple-Mono-NF-CN/ ./Maple-Mono-NF-CN/
        maple_version=$(curl -sSL https://api.github.com/repos/subframe7536/maple-font/releases/latest | jq -r '.tag_name')
        echo "maple_version=$maple_version" >> ${GITHUB_ENV}
        maple_time=$(curl -sSL https://api.github.com/repos/subframe7536/maple-font/releases/latest | jq -r '.created_at' | xargs -I {} date -d '{} +8 hours' '+%Y-%m-%d')
        echo "maple_time=$maple_time" >> ${GITHUB_ENV}
        wget -P ./tmp/ "${maple_download_url}/${maple_version}/MapleMono-NF-CN-unhinted.zip"
        unzip -o ./tmp/MapleMono-NF-CN-unhinted.zip -d ./tmp/Maple-Mono-NF-CN/
        cp -f ./tmp/Maple-Mono-NF-CN/MapleMono-NF-CN-* ./Maple-Mono-NF-CN/
        rm -rf ./tmp*

    - name: Download `LxgwWenKai`
      run: |
        mkdir -p ./tmp/LxgwWenKai/ ./LxgwWenKai/
        lxgw_version=$(curl -sSL https://api.github.com/repos/lxgw/LxgwWenKai/releases/latest | jq -r '.tag_name')
        echo "lxgw_version=$lxgw_version" >> ${GITHUB_ENV}
        lxgw_time=$(curl -sSL https://api.github.com/repos/lxgw/LxgwWenKai/releases/latest | jq -r '.created_at' | xargs -I {} date -d '{} +8 hours' '+%Y-%m-%d')
        echo "lxgw_time=$lxgw_time" >> ${GITHUB_ENV}
        wget -P ./tmp/ "${lxgw_download_url}/${lxgw_version}/lxgw-wenkai-${lxgw_version}.zip"
        unzip -o "./tmp/lxgw-wenkai-${lxgw_version}.zip" -d ./tmp/
        cp -f ./tmp/lxgw-wenkai-${lxgw_version}/LXGWWenKai-* ./LxgwWenKai/
        rm -rf ./tmp*

    - name: Download `Source Han Serif`
      run: |
        mkdir -p ./tmp/Source-Han-Serif/ ./Source-Han-Serif/
        source_version=$(curl -sSL https://api.github.com/repos/adobe-fonts/source-han-serif/releases/latest | jq -r '.tag_name')
        echo "source_version=$source_version" >> ${GITHUB_ENV}
        source_time=$(curl -sSL https://api.github.com/repos/adobe-fonts/source-han-serif/releases/latest | jq -r '.created_at' | xargs -I {} date -d '{} +8 hours' '+%Y-%m-%d')
        echo "source_time=$source_time" >> ${GITHUB_ENV}
        wget -P ./tmp/ "${source_download_url}/${source_version}/09_SourceHanSerifSC.zip"
        unzip -o ./tmp/09_SourceHanSerifSC.zip -d ./tmp/
        cp -f ./tmp/OTF/SimplifiedChinese/SourceHanSerifSC-* ./Source-Han-Serif/
        rm -rf ./tmp*

    - name: Download `Noto Color Emoji`
      run: |
        mkdir -p ./Noto-Color-Emoji/
        noto_version=$(curl -sSL https://raw.githubusercontent.com/googlefonts/noto-emoji/main/NotoColorEmoji.tmpl.ttx.tmpl | grep 'noto-emoji' | awk -F '[ ;]+' '{print $3}')
        echo "noto_version=$noto_version" >> ${GITHUB_ENV}
        noto_time=$(curl -sSL https://raw.githubusercontent.com/googlefonts/noto-emoji/main/NotoColorEmoji.tmpl.ttx.tmpl | grep 'noto-emoji' | awk -F ':' '{print $2}' | xargs -I {} date -d '{} +8 hours' '+%Y-%m-%d')
        echo "noto_time=$noto_time" >> ${GITHUB_ENV}
        wget -P ./Noto-Color-Emoji/ "${noto_download_url}"


    - name: Zip `MiSans`
      uses: montudor/action-zip@v1
      with:
        args: zip -qq -r ./fonts/MiSans.zip ./MiSans/

    - name: Zip `Resource Han Rounded CN`
      uses: montudor/action-zip@v1
      with:
        args: zip -qq -r ./fonts/Resource-Han-Rounded-CN.zip ./Resource-Han-Rounded-CN/

    - name: Zip `Maple Mono NF CN`
      uses: montudor/action-zip@v1
      with:
        args: zip -qq -r ./fonts/Maple-Mono-NF-CN.zip ./Maple-Mono-NF-CN/

    - name: Zip `LxgwWenKai`
      uses: montudor/action-zip@v1
      with:
        args: zip -qq -r ./fonts/LxgwWenKai.zip ./LxgwWenKai/

    - name: Zip `Source Han Serif`
      uses: montudor/action-zip@v1
      with:
        args: zip -qq -r ./fonts/Source-Han-Serif.zip ./Source-Han-Serif/

    - name: Zip `Noto Color Emoji`
      uses: montudor/action-zip@v1
      with:
        args: zip -qq -r ./fonts/Noto-Color-Emoji.zip ./Noto-Color-Emoji/

    - name: Release and upload `fonts` assets
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        release_name: fonts
        tag: fonts
        overwrite: true
        body: |
          更新 [MiSans](https://hyperos.mi.com/font) 字体，发布于 ${{ env.misans_time }}
          更新 [Resource Han Rounded CN](https://github.com/CyanoHao/Resource-Han-Rounded) 字体至 v${{ env.resource_version }}，发布于 ${{ env.resource_time }}
          更新 [Maple Mono NF CN](https://github.com/subframe7536/maple-font) 字体至 ${{ env.maple_version }}，发布于 ${{ env.maple_time }}
          更新 [LxgwWenKai](https://github.com/lxgw/LxgwWenKai) 字体至 ${{ env.lxgw_version }}，发布于 ${{ env.lxgw_time }}
          更新 [Source Han Serif](https://github.com/adobe-fonts/source-han-serif) 字体至 v${{ env.source_version }}，发布于 ${{ env.source_time }}
          更新 [Noto Color Emoji](https://github.com/googlefonts/noto-emoji) 字体至 v${{ env.noto_version }}，发布于 ${{ env.noto_time }}
        file_glob: true
        file: ./fonts/*

    - name: Delete old workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ github.token }}
        repository: ${{ github.repository }}
        retain_days: 3
        keep_minimum_runs: 1
